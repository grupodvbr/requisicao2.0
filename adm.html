<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>Requisi√ß√µes ‚Ä¢ Mercatto</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<style>
/* ===== VARI√ÅVEIS ===== */
:root{
  --azul:#2563eb;
  --pendente:#f3f4f6;
  --carrinho:#dbeafe;
  --comprado:#fef3c7;
  --negado:#fee2e2;
  --entregue:#dcfce7;
  --semestoque:#ede9fe;
  --bg:#ffffff;
  --ink:#0f172a;
  --muted:#64748b;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,Arial;
  background:#f1f5f9;
  color:var(--ink);
}

/* ===== HEADER ===== */
header{
  position:sticky;top:0;z-index:30;
  background:#fff;
  padding:10px 14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #e5e7eb;
}
header h1{margin:0;font-size:1.1em;font-weight:800}

/* ===== RESUMO ===== */
.resumo{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:8px;
  padding:10px;
}
.card{
  padding:10px;
  border-radius:12px;
  font-size:13px;
  font-weight:800;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}
.card span{
  background:#fff;
  padding:4px 10px;
  border-radius:999px;
}
.card.pendente{background:var(--pendente)}
.card.carrinho{background:var(--carrinho)}
.card.comprado{background:var(--comprado)}
.card.negado{background:var(--negado)}
.card.entregue{background:var(--entregue)}
.card.semestoque{background:var(--semestoque)}

/* ===== FILTROS ===== */
.filtros{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:8px;
  padding:10px;
  background:#fff;
  position:sticky;
  top:52px;
  z-index:20;
}
.filtros input,.filtros select{
  padding:8px;
  border-radius:8px;
  border:1px solid #cbd5e1;
  font-size:13px;
}

/* ===== TABELA ===== */
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  font-size:13px;
}
thead{
  background:var(--azul);
  color:#fff;
  position:sticky;
  top:140px;
}
th,td{
  padding:8px;
  border:1px solid #e5e7eb;
  text-align:center;
}
td.produto,td.qtd{
  user-select:none;
  cursor:pointer;
}
td.obs{font-size:12px;color:var(--muted)}
select.status{
  padding:4px;border-radius:6px;
}

/* ===== POPUPS ===== */
.overlay{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.4);
  z-index:9999;
  align-items:center;
  justify-content:center;
}
.popup{
  background:#fff;
  width:92%;
  max-width:520px;
  border-radius:16px;
  padding:16px;
  max-height:80vh;
  overflow:auto;
}
.popup button{
  width:100%;
  margin-top:10px;
  padding:10px;
  border:none;
  border-radius:10px;
  font-weight:800;
}
.btn-primary{background:var(--azul);color:#fff}
.btn-danger{background:#dc2626;color:#fff}
#camera{width:100%;height:260px;background:#000;border-radius:12px;margin-top:10px}
</style>
</head>

<body>

<header>
  <h1>üìã Requisi√ß√µes</h1>
</header>

<div class="resumo">
  <div class="card pendente">PENDENTE <span id="cP">0</span></div>
  <div class="card carrinho">CARRINHO <span id="cC">0</span></div>
  <div class="card comprado">COMPRADO <span id="cCO">0</span></div>
  <div class="card negado">NEGADO <span id="cN">0</span></div>
  <div class="card entregue">ENTREGUE <span id="cE">0</span></div>
  <div class="card semestoque">SEM ESTOQUE <span id="cSE">0</span></div>
</div>

<div class="filtros">
  <input type="date" id="dataInicio">
  <input type="date" id="dataFim">
  <input type="text" id="fItem" placeholder="Item / Obs">
  <select id="fStatus">
    <option value="PENDENTE">PENDENTE</option>
    <option value="TODOS">TODOS</option>
    <option>NO CARRINHO</option>
    <option>COMPRADO</option>
    <option>NEGADO</option>
    <option>ENTREGUE</option>
    <option>SEM ESTOQUE</option>
  </select>
  <select id="fSetor"></select>
  <select id="fUsuario"></select>
</div>

<table>
<thead>
<tr>
  <th>Data</th><th>Produto</th><th>Qtd</th><th>Un</th>
  <th>Setor</th><th>Solicitante</th><th>Obs</th><th>Status</th>
</tr>
</thead>
<tbody id="tabela"></tbody>
</table>

<script>
const sb = supabase.createClient(
 "https://mybsriouiwqsdufujbsc.supabase.co",
 "sb_publishable_AUyBEIVCAMUoXwDKUmlqSw_v8EY8rVN"
);

let dados = [];
let vfToken = null;

/* ===== AUTH VF ===== */
async function autenticarVF(){
  const t = sessionStorage.getItem("vf_token");
  if(t){ vfToken = t; return; }

  const r = await fetch("/api/auth",{method:"POST"});
  const j = await r.json();
  vfToken = j.accessToken;
  sessionStorage.setItem("vf_token",vfToken);
}

/* ===== LOAD ===== */
async function carregar(){
  const {data} = await sb.from("requisicoes").select("*").order("created_at",{ascending:false});
  dados = data || [];
  preencherFiltros();
  filtrar();
  calcularResumo();
}

(async()=>{
  await autenticarVF();
  await carregar();
})();

/* ===== STATUS COM CONTROLE ===== */
async function mudarStatus(id, novoStatus){
  const select = event.target;

  const {data: req} = await sb
    .from("requisicoes")
    .select("*")
    .eq("id",id)
    .single();

  const statusAnterior = req.status || "PENDENTE";

  try{
    const resp = await fetch("/api/requisicao-sync",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body:JSON.stringify({
        token:vfToken,
        requisicao:req,
        novoStatus
      })
    });

    if(!resp.ok){
      throw new Error("API VF falhou");
    }

    const json = await resp.json();

    // üîí REGRA CR√çTICA
    if(novoStatus === "ENTREGUE" && !json.vf_requisicao_id){
      throw new Error("Entrega n√£o confirmada no VF");
    }

    await sb.from("requisicoes").update({
      status:novoStatus,
      vf_requisicao_id: json.vf_requisicao_id ?? req.vf_requisicao_id,
      vf_status: json.acao,
      vf_enviado_em: new Date().toISOString()
    }).eq("id",id);

    const local = dados.find(d=>d.id===id);
    local.status = novoStatus;

    filtrar();
    calcularResumo();

  }catch(e){
    alert("‚ùå Status N√ÉO alterado.\nErro ao registrar no Varejo F√°cil.");
    select.value = statusAnterior; // rollback visual
  }
}
</script>

</body>
</html>
