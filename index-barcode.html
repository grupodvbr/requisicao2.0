<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Requisi√ß√£o de Compras ‚Ä¢ Del√≠cia Gourmet</title>

<meta name="viewport"
content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">

<meta name="theme-color" content="#1e40af">
<link rel="manifest" href="/manifest.json">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/@ericblade/quagga2/dist/quagga.min.js"></script>

<style>
/* =========================================================
   RESET + BASE
========================================================= */
* {
  box-sizing: border-box;
  -webkit-tap-highlight-color: transparent;
}

html, body {
  margin: 0;
  padding: 0;
  touch-action: manipulation;
}

body {
  font-family: 'Inter', Arial, sans-serif;
  background: linear-gradient(180deg, #eef2ff 0%, #f8fafc 100%);
  display: flex;
  justify-content: center;
  padding: 14px;
  color: #0f172a;
}

/* =========================================================
   CONTAINER PRINCIPAL
========================================================= */
.container {
  background: #ffffff;
  border-radius: 24px;
  box-shadow:
    0 10px 25px rgba(0,0,0,0.08),
    0 30px 60px rgba(0,0,0,0.08);
  max-width: 520px;
  width: 100%;
  padding: 20px 18px 22px;
  position: relative;
}

/* =========================================================
   TOPO / HEADER
========================================================= */
.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.topbar h1 {
  margin: 0;
  font-size: 18px;
  font-weight: 800;
  letter-spacing: -0.3px;
}

/* BOT√ÉO LOGOUT */
.btn-logout {
  width: auto;
  padding: 6px 14px;
  font-size: 12px;
  font-weight: 800;
  border-radius: 999px;
  border: none;
  background: #fee2e2;
  color: #991b1b;
  cursor: pointer;
  transition: all .2s ease;
}

.btn-logout:hover {
  background: #fecaca;
}

/* =========================================================
   FORMUL√ÅRIOS
========================================================= */
label {
  display: block;
  margin-top: 14px;
  margin-bottom: 4px;
  font-size: 13px;
  font-weight: 700;
  color: #1e293b;
}

input,
select,
textarea {
  width: 100%;
  padding: 14px;
  border-radius: 14px;
  border: 1px solid #cbd5e1;
  font-size: 15px;
  font-family: inherit;
  outline: none;
  background: #ffffff;
  transition: all .15s ease;
}

input:focus,
select:focus,
textarea:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 3px rgba(37,99,235,0.15);
}

input[readonly] {
  background: #f1f5f9;
  color: #334155;
}

textarea {
  min-height: 90px;
  resize: none;
}

/* =========================================================
   BOT√ïES
========================================================= */
button {
  width: 100%;
  padding: 14px;
  margin-top: 12px;
  border-radius: 16px;
  border: none;
  font-size: 15px;
  font-weight: 800;
  cursor: pointer;
  position: relative;
  transition: all .2s ease;
}

button:active {
  transform: scale(0.98);
}

/* PRIM√ÅRIO */
.btn-primary {
  background: linear-gradient(180deg, #2563eb, #1e40af);
  color: #ffffff;
}

.btn-primary:hover {
  filter: brightness(1.05);
}

/* MUTED */
.btn-muted {
  background: #e5e7eb;
  color: #0f172a;
}

.btn-muted:hover {
  background: #d1d5db;
}

/* LOADING OVERLAY */
button.loading {
  pointer-events: none;
}

button.loading::after {
  content: "Enviando‚Ä¶";
  position: absolute;
  inset: 0;
  background: rgba(15, 23, 42, 0.55);
  color: #ffffff;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 16px;
  font-weight: 800;
}

/* =========================================================
   CAMERA / LEITOR
========================================================= */
#camera {
  display: none;
  width: 100%;
  height: 260px;
  margin-top: 14px;
  border-radius: 18px;
  overflow: hidden;
  background: #000;
}

#camera video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#codigoLido {
  margin-top: 8px;
  text-align: center;
  font-size: 13px;
  font-weight: 800;
  color: #2563eb;
}

/* =========================================================
   BADGE / UNIDADE
========================================================= */
.badge {
  display: inline-block;
  margin-top: 10px;
  padding: 8px 16px;
  font-size: 13px;
  font-weight: 800;
  border-radius: 999px;
  background: #e0f2fe;
  color: #0369a1;
}

/* =========================================================
   BUSCA POR NOME (LISTA)
========================================================= */
#listaProdutos {
  margin-top: 6px;
}

.item {
  background: #f1f5f9;
  border-radius: 12px;
  padding: 12px;
  margin-top: 6px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all .15s ease;
}

.item:hover {
  background: #e2e8f0;
}

/* =========================================================
   HIST√ìRICO
========================================================= */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
  font-size: 13px;
  border-radius: 14px;
  overflow: hidden;
}

th, td {
  border: 1px solid #e5e7eb;
  padding: 8px;
  text-align: center;
}

th {
  background: #f1f5f9;
  font-weight: 800;
}

tbody tr:nth-child(even) {
  background: #f8fafc;
}

/* BOT√ÉO EXCLUIR */
.btn-delete {
  background: #fee2e2;
  color: #991b1b;
  border: none;
  border-radius: 10px;
  padding: 6px 10px;
  font-size: 12px;
  font-weight: 800;
  cursor: pointer;
}

.btn-delete:hover {
  background: #fecaca;
}

/* =========================================================
   UTILIDADES
========================================================= */
.hidden {
  display: none !important;
}

</style>
</head>

<body>
<div class="container">

<div class="topbar">
  <h1>üìã Requisi√ß√£o</h1>
<button class="btn-logout" id="btnLogout">Sair</button>
</div>

<!-- LOGIN -->
<div id="loginArea">
  <label>Usu√°rio</label>
  <input id="usuario">
  <label>Senha</label>
  <input id="senha" type="password">
  <button class="btn-primary" id="btnLogin">Entrar</button>
</div>

<!-- APP -->
<div id="appArea" class="hidden">

<label>Setor</label>
<select id="setor">
  <option>Cozinha</option>
  <option>Limpeza</option>
  <option>Bar</option>
</select>

<label></label>
<input id="barcode" placeholder="Digite ou escaneie">
<label>Modo de busca</label>
<select id="modoBusca">
  <option value="barcode">C√≥digo de Barras</option>
  <option value="nome">Nome do produto</option>
  <option value="id">ID do produto</option>
</select>

<div id="buscaNome" class="hidden">
  <label>Buscar por nome</label>
  <input id="buscaProdutoNome" placeholder="Digite o nome do produto">
  <div id="listaProdutos"></div>
</div>

<div id="buscaId" class="hidden">
  <label>Buscar por ID</label>
  <input id="buscaProdutoId" type="number" inputmode="numeric" placeholder="Digite o ID">
</div>

<button class="btn-muted" id="btnManual">Buscar manual</button>
<button class="btn-primary" id="btnOpenCamera">Abrir c√¢mera</button>
<button class="btn-muted hidden" id="btnCloseCamera">Fechar c√¢mera</button>

<div id="camera"></div>
<div id="codigoLido"></div>

<label>Produto</label>
<input id="produto" readonly>

<div id="unidadeBox"></div>

<label>Quantidade</label>
<input type="number" id="quantidade" min="1">

<label>Observa√ß√µes</label>
<textarea id="observacoes"></textarea>

<button class="btn-primary" id="btnEnviar">Enviar requisi√ß√£o</button>

<h3 style="margin-top:20px">Hist√≥rico (7 dias)</h3>
<table>
<thead>
<tr>
<th>Produto</th><th>Qtd</th><th>Status</th><th>A√ß√£o</th>
</tr>
</thead>
<tbody id="historico"></tbody>
</table>

</div>

<audio id="beep">
<source src="data:audio/wav;base64,UklGRlIAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQwAAAAA">
</audio>

</div>

<script>
/* ===== SUPABASE ===== */
const sb=supabase.createClient(
 "https://mybsriouiwqsdufujbsc.supabase.co",
 "sb_publishable_AUyBEIVCAMUoXwDKUmlqSw_v8EY8rVN"
);

const normalizar=c=>"0"+String(c).replace(/\D/g,"");

/* ===== ESTADO ===== */
let usuarioLogado=JSON.parse(localStorage.getItem("usuario"));
let unidadeAuto="",barcodeFinal="";
let enviando=false;
const modoBuscaEl = document.getElementById("modoBusca");
const buscaNomeEl = document.getElementById("buscaNome");
const buscaIdEl = document.getElementById("buscaId");

const barcodeInput = document.getElementById("barcode");
const btnManual = document.getElementById("btnManual");
const btnOpenCamera = document.getElementById("btnOpenCamera");
const btnCloseCamera = document.getElementById("btnCloseCamera");

function aplicarModoBusca() {
  const modo = modoBuscaEl.value;

  // Esconde tudo
  barcodeInput.classList.add("hidden");
  buscaNomeEl.classList.add("hidden");
  buscaIdEl.classList.add("hidden");
  btnManual.classList.add("hidden");
  btnOpenCamera.classList.add("hidden");
  btnCloseCamera.classList.add("hidden");
  camera.classList.add("hidden");
  codigoLido.textContent = "";

  // Fecha c√¢mera se estiver aberta
  try { Quagga.stop(); } catch (e) {}

  // === MODO C√ìDIGO DE BARRAS ===
  if (modo === "barcode") {
    barcodeInput.classList.remove("hidden");
    btnManual.classList.remove("hidden");
    btnOpenCamera.classList.remove("hidden");
  }

  // === MODO ID ===
  if (modo === "id") {
    buscaIdEl.classList.remove("hidden");
    btnManual.classList.remove("hidden");
  }

  // === MODO NOME ===
  if (modo === "nome") {
    buscaNomeEl.classList.remove("hidden");
  }
}

// Eventos
modoBuscaEl.addEventListener("change", aplicarModoBusca);

// Aplica ao iniciar a tela
aplicarModoBusca();


/* ===== SETOR PERSISTENTE ===== */
const setorEl=document.getElementById("setor");
setorEl.value=localStorage.getItem("setor")||setorEl.value;
setorEl.onchange=()=>localStorage.setItem("setor",setorEl.value);

/* ===== LOGIN ===== */
btnLogin.onclick=async()=>{
 const {data}=await sb.from("usuarios")
 .select("*")
 .eq("usuario",usuario.value)
 .eq("senha",senha.value)
 .eq("ativo",true)
 .single();
 if(!data) return;
 localStorage.setItem("usuario",JSON.stringify(data.usuario));
 init();
};

/* ===== INIT ===== */
async function init(){
  loginArea.classList.add("hidden");
  appArea.classList.remove("hidden");
  btnLogout.classList.remove("hidden");

  await gerarTokenVF();   // üî• ISSO √â O QUE FALTAVA
  carregarHistorico();
};
if(usuarioLogado) init();

/* ===== LOGOUT ===== */
btnLogout.onclick=()=>{
 localStorage.removeItem("usuario");
 location.reload();
};

/* ===== BUSCAR PRODUTO (SEM ERRO VISUAL) ===== */
async function buscarProduto(code){
 barcodeFinal=code;
 codigoLido.textContent=`Lendo c√≥digo: ${code}`;
 try{
  const r=await fetch(`/api/buscar-barcode?barcode=${code}`);
  const j=await r.json();
  if(j?.produto){
   produto.value=j.produto.descricao;
   unidadeAuto=j.produto.unidadeDeVenda;
   unidadeBox.innerHTML=`<div class="badge">${unidadeAuto}</div>`;
   beep.play();
   fecharCamera();
  }
 }catch{}
}

/* ===== CAMERA ===== */
btnOpenCamera.onclick=()=>{
 camera.style.display="block";
 btnOpenCamera.classList.add("hidden");
 btnCloseCamera.classList.remove("hidden");
 codigoLido.textContent="";
 Quagga.init({
  inputStream:{type:"LiveStream",target:camera,constraints:{facingMode:"environment"}},
  decoder:{readers:["ean_reader","ean_8_reader","upc_reader","code_128_reader"]}
 },()=>Quagga.start());
 Quagga.onDetected(r=>buscarProduto(normalizar(r.codeResult.code)));
};
btnCloseCamera.onclick=fecharCamera;
function fecharCamera(){
 Quagga.stop();
 camera.style.display="none";
 btnOpenCamera.classList.remove("hidden");
 btnCloseCamera.classList.add("hidden");
}
btnManual.onclick = () => {
  const modo = modoBuscaEl.value;

  if (modo === "barcode" && barcode.value) {
    buscarProduto(normalizar(barcode.value));
  }

  if (modo === "id" && buscaProdutoId.value) {
    buscaProdutoId.dispatchEvent(new Event("change"));
  }
};

btnEnviar.onclick = async () => {
  if (enviando || !produto.value || !quantidade.value) return;

  enviando = true;
  btnEnviar.classList.add("loading");

  await sb.from("requisicoes").insert({
    usuario: usuarioLogado,
    setor: setorEl.value,
    produto: produto.value,
    unidade: unidadeAuto,
    quantidade: quantidade.value,
    observacoes: observacoes.value,
    barcode: barcodeFinal,
    status: "PENDENTE"
  });

  btnEnviar.classList.remove("loading");
  enviando = false;

  // üî• LIMPA PARA NOVO REGISTRO (SEM MEXER NO SETOR)
  limparBuscaParaNovoRegistro();

  carregarHistorico();
};



/* ===== HIST√ìRICO ===== */
async function carregarHistorico(){
 historico.innerHTML="";
 const seteDias=new Date(Date.now()-7*86400000).toISOString();
 const {data}=await sb.from("requisicoes")
 .select("*")
 .eq("usuario",usuarioLogado)
 .gte("created_at",seteDias)
 .order("created_at",{ascending:false});
 (data||[]).forEach(r=>{
  const horas=(Date.now()-new Date(r.created_at))/3600000;
  historico.insertAdjacentHTML("beforeend",`
   <tr id="row-${r.id}">
    <td>${r.produto}</td>
    <td>${r.quantidade}</td>
    <td>${r.status}</td>
    <td>${horas<=1?`<button class="btn-delete" onclick="excluir('${r.id}')">Excluir</button>`:"-"}</td>
   </tr>`);
 });
}

/* ===== EXCLUIR ===== */
async function excluir(id){
 const {data}=await sb.rpc("excluir_requisicao",{p_id:id,p_usuario:usuarioLogado});
 if(data) document.getElementById("row-"+id)?.remove();
}
buscaProdutoNome.onkeyup = async () => {
  const q = buscaProdutoNome.value.trim();
  if (q.length < 2) return;

  const r = await fetch(`/api/produtos-busca?q=${encodeURIComponent(q)}`);
  const j = await r.json();

  listaProdutos.innerHTML = "";

  (j.items || []).forEach(p => {
    listaProdutos.insertAdjacentHTML(
      "beforeend",
      `<div class="item" onclick='selecionarProduto(${JSON.stringify(p)})'>
        ${p.descricao}
      </div>`
    );
  });
};

function selecionarProduto(p){
  produto.value = p.descricao;
  unidadeAuto = p.unidadeDeVenda;
  unidadeBox.innerHTML = `<div class="badge">${unidadeAuto}</div>`;
  listaProdutos.innerHTML = "";
}
buscaProdutoId.onchange = async () => {
  const id = buscaProdutoId.value;
  if (!id) return;

  // üîê pega token do localStorage ou de onde voc√™ j√° usa
  const token = localStorage.getItem("vf_token");

  const r = await fetch(`/api/buscar-id?id=${id}`, {
    headers: {
      Authorization: token
    }
  });

  const j = await r.json();

  if (j?.items?.length) {
    const p = j.items[0];
    produto.value = p.descricao;
    unidadeAuto = p.unidadeDeVenda;
    unidadeBox.innerHTML = `<div class="badge">${unidadeAuto}</div>`;
  }
};

async function gerarTokenVF() {
  try {
    const r = await fetch("/api/auth");
    const j = await r.json();

    if (!j.accessToken) {
      console.error("Auth inv√°lido:", j);
      alert("Erro ao autenticar no Varejo F√°cil");
      return;
    }

    localStorage.setItem("vf_token", j.accessToken);
    console.log("TOKEN VF GERADO");
  } catch (err) {
    console.error("Erro auth VF:", err);
  }
}
function limparBuscaParaNovoRegistro() {
  barcode.value = "";
  buscaProdutoNome.value = "";
  buscaProdutoId.value = "";

  produto.value = "";
  quantidade.value = "";
  observacoes.value = "";

  unidadeAuto = "";
  unidadeBox.innerHTML = "";
  listaProdutos.innerHTML = "";
  codigoLido.textContent = "";

  // Fecha c√¢mera se estiver aberta
  try { Quagga.stop(); } catch(e){}
  camera.style.display = "none";
  btnOpenCamera.classList.remove("hidden");
  btnCloseCamera.classList.add("hidden");
}

</script>
</body>
</html>
