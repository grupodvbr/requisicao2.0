<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ficha T√©cnica ‚Ä¢ Cadastro</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{margin:0;padding:16px;background:#f4f6f8;font-family:Inter}
.container{max-width:860px;margin:auto;background:#fff;border-radius:24px;padding:24px;box-shadow:0 30px 60px rgba(0,0,0,.1)}
h1{margin:0 0 20px;font-weight:800}
label{font-weight:800;font-size:13px;margin-top:14px;display:block}
input,button{width:100%;padding:14px;border-radius:14px;border:1px solid #cbd5e1;margin-top:6px}
button{background:#2563eb;color:#fff;font-weight:800;border:none}
.lista .item{background:#f1f5f9;padding:12px;border-radius:12px;margin-top:6px;cursor:pointer}
.grid{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:6px}
.kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:20px}
.kpi{background:#f8fafc;border-radius:16px;padding:16px;text-align:center;font-weight:800}
img{width:100%;border-radius:18px;margin-top:10px}
</style>
</head>

<body>
<div class="container">
<h1>üìã Ficha T√©cnica</h1>

<label>Produto</label>
<input id="buscaProduto">
<div id="listaProduto" class="lista"></div>

<label>Imagem do prato</label>
<input type="file" id="foto">

<hr>

<h3>üç≥ Ingredientes</h3>

<label>Buscar ingrediente</label>
<input id="buscaIngrediente">
<div id="listaIngrediente" class="lista"></div>

<div class="grid">
  <input id="qtd" type="number" placeholder="Qtd usada">
  <input id="un" readonly placeholder="Un">
  <input id="custo" readonly placeholder="Custo">
  <input id="rend" type="number" placeholder="Rend %">
  <button onclick="addIngrediente()">+</button>
</div>

<div id="listaIng"></div>

<hr>

<label>Rendimento final</label>
<input id="rendimentoFinal" type="number" value="1">

<div class="kpis">
  <div class="kpi">CMV Total<br>R$ <span id="cmvTotal">0.00</span></div>
  <div class="kpi">CMV Unit<br>R$ <span id="cmvUnit">0.00</span></div>
  <div class="kpi">Pre√ßo Venda<br>R$ <span id="precoVenda">0.00</span></div>
  <div class="kpi">Margem<br><span id="margem">0</span>%</div>
</div>

<button onclick="salvar()">Salvar Ficha T√©cnica</button>
</div>

<script>
const sb = supabase.createClient("https://dsngsuetvucxeztbgbtb.supabase.co","sb_publishable_rN6fZXNxnjgwnbXTPXEP5A_7n5Ty9Cp");

let produto=null, ingrediente=null, ingredientes=[], cmv=0, preco=0;

buscaProduto.onkeyup=async()=>{
  if(buscaProduto.value.length<2)return listaProduto.innerHTML="";
  const r=await fetch(`/api/produtos-busca?q=${buscaProduto.value}`);
  const j=await r.json();
  listaProduto.innerHTML="";
  j.items.forEach(p=>{
    listaProduto.innerHTML+=`<div class="item" onclick='selectProduto(${JSON.stringify(p)})'>${p.descricao}</div>`;
  });
};
function selectProduto(p){
  produto=p;
  preco=p.precoVenda1||0;
  precoVenda.innerText=preco.toFixed(2);
  listaProduto.innerHTML="";
}

buscaIngrediente.onkeyup=async()=>{
  if(buscaIngrediente.value.length<2)return listaIngrediente.innerHTML="";
  const r=await fetch(`/api/produtos-busca?q=${buscaIngrediente.value}`);
  const j=await r.json();
  listaIngrediente.innerHTML="";
  j.items.forEach(p=>{
    listaIngrediente.innerHTML+=`<div class="item" onclick='selectIng(${JSON.stringify(p)})'>${p.descricao}</div>`;
  });
};
function selectIng(p){
  ingrediente=p;
  un.value=p.unidadeDeVenda;
  custo.value=(p.custoMedio||p.custo||0).toFixed(2);
  listaIngrediente.innerHTML="";
}

function addIngrediente(){
  const c=(qtd.value*custo.value)*(rend.value/100||1);
  ingredientes.push({nome:ingrediente.descricao,custo:c});
  cmv+=c;
  render();
}
function render(){
  listaIng.innerHTML=ingredientes.map(i=>`<p>${i.nome} - R$ ${i.custo.toFixed(2)}</p>`).join("");
  cmvTotal.innerText=cmv.toFixed(2);
  cmvUnit.innerText=(cmv/rendimentoFinal.value).toFixed(2);
  margem.innerText=preco?(((preco-cmv)/preco)*100).toFixed(1):0;
}

async function salvar(){
  let fotoUrl=null;
  if(foto.files[0]){
    const path=`${Date.now()}-${foto.files[0].name}`;
    await sb.storage.from("ficha_tecnica").upload(path,foto.files[0]);
    fotoUrl=sb.storage.from("ficha_tecnica").getPublicUrl(path).data.publicUrl;
  }
  await sb.from("ficha_tecnica").insert({
    produto_nome:produto.descricao,
    receita:ingredientes,
    custo_total:cmv,
    custo_unitario:cmv/rendimentoFinal.value,
    preco_venda:preco,
    margem,
    foto_url:fotoUrl
  });
  alert("Ficha salva");
}
</script>
</body>
</html>
