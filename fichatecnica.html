<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Ficha T√©cnica ‚Ä¢ CLENA</title>

<meta name="viewport"
content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
/* ================= BASE ================= */
*{box-sizing:border-box}
body{
  margin:0;
  padding:14px;
  font-family:Inter,Arial,sans-serif;
  background:linear-gradient(180deg,#eef2ff,#f8fafc);
  display:flex;
  justify-content:center;
  color:#0f172a;
}
.container{
  background:#fff;
  max-width:560px;
  width:100%;
  border-radius:24px;
  padding:20px;
  box-shadow:0 20px 50px rgba(0,0,0,.12);
}
h1{margin:0 0 14px;font-size:20px;font-weight:800}

/* ================= FORM ================= */
label{
  margin-top:14px;
  display:block;
  font-size:13px;
  font-weight:800;
}
input,select,textarea,button{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #cbd5e1;
  margin-top:6px;
  font-size:15px;
}
input:focus,textarea:focus{
  outline:none;
  border-color:#2563eb;
  box-shadow:0 0 0 3px rgba(37,99,235,.15);
}
button{
  margin-top:14px;
  border:none;
  font-weight:800;
  cursor:pointer;
}
.btn{
  background:linear-gradient(180deg,#2563eb,#1e40af);
  color:#fff;
}
.badge{
  display:inline-block;
  margin-top:10px;
  padding:8px 16px;
  border-radius:999px;
  background:#e0f2fe;
  color:#0369a1;
  font-weight:800;
}

/* ================= BUSCA ================= */
#listaProdutos .item{
  background:#f1f5f9;
  border-radius:12px;
  padding:12px;
  margin-top:6px;
  font-weight:600;
  cursor:pointer;
}
#listaProdutos .item:hover{
  background:#e2e8f0;
}

/* ================= RECEITA ================= */
.grid{
  display:grid;
  grid-template-columns:2fr 1fr 1fr 1fr auto;
  gap:6px;
  margin-top:10px;
}
.total{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:10px;
  margin-top:14px;
}
.total div{
  background:#f8fafc;
  padding:12px;
  border-radius:12px;
  text-align:center;
  font-weight:800;
}

/* ================= LISTA ================= */
table{
  width:100%;
  border-collapse:collapse;
  margin-top:18px;
  font-size:13px;
}
th,td{
  border:1px solid #e5e7eb;
  padding:8px;
  text-align:center;
}
tr:hover{background:#f8fafc;cursor:pointer}

/* ================= MODAL ================= */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.55);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal-box{
  background:#fff;
  max-width:520px;
  width:100%;
  border-radius:20px;
  padding:20px;
  max-height:90vh;
  overflow:auto;
}
</style>
</head>

<body>
<div class="container">

<h1>üìã Ficha T√©cnica</h1>

<label>Buscar produto (nome)</label>
<input id="buscaProdutoNome" placeholder="Digite o nome do produto">
<div id="listaProdutos"></div>

<input id="produto" readonly placeholder="Produto selecionado">
<div id="unidadeBox"></div>

<h3>üç≥ Receita</h3>
<div class="grid">
  <input id="ing" placeholder="Ingrediente">
  <input id="qtd" type="number" placeholder="Qtd">
  <select id="un">
    <option>g</option><option>kg</option><option>ml</option><option>l</option>
    <option>un</option><option>pct</option>
  </select>
  <input id="custo" type="number" placeholder="Custo unit">
  <button onclick="addIng()">+</button>
</div>

<div id="listaIng"></div>

<label>Rendimento</label>
<input id="rendimento" type="number">

<div class="total">
  <div>Custo Total<br>R$ <span id="total">0.00</span></div>
  <div>Rendimento<br><span id="rend">0</span></div>
  <div>Custo Unit√°rio<br>R$ <span id="unit">0.00</span></div>
</div>

<button class="btn" onclick="salvar()">Salvar Ficha T√©cnica</button>

<h3 style="margin-top:20px">üìö Fichas Cadastradas</h3>
<table id="tabela">
<tr><th>Produto</th><th>Un</th><th>Custo</th></tr>
</table>

</div>

<div class="modal" id="modal">
  <div class="modal-box">
    <button onclick="modal.style.display='none'">Fechar</button>
    <pre id="modalConteudo"></pre>
  </div>
</div>

<script>
/* ===== SUPABASE ===== */
const sb = supabase.createClient(
  "https://dsngsuetvucxeztbgbtb.supabase.co",
  "sb_publishable_rN6fZXNxnjgwnbXTPXEP5A_7n5Ty9Cp"
);

let produtoVF=null;
let receita=[];
let total=0;

/* ===== BUSCA POR NOME (IGUAL AO SEU MODELO) ===== */
buscaProdutoNome.onkeyup = async () => {
  const q = buscaProdutoNome.value.trim();
  if(q.length<2){listaProdutos.innerHTML="";return;}

  const r = await fetch(`/api/produtos-busca?q=${encodeURIComponent(q)}`);
  const j = await r.json();

  listaProdutos.innerHTML="";
  (j.items||[]).forEach(p=>{
    listaProdutos.insertAdjacentHTML("beforeend",`
      <div class="item" onclick='selecionarProduto(${JSON.stringify(p)})'>
        ${p.descricao}
      </div>
    `);
  });
};

function selecionarProduto(p){
  produtoVF=p;
  produto.value=p.descricao;
  unidadeBox.innerHTML=`<div class="badge">${p.unidadeDeVenda}</div>`;
  listaProdutos.innerHTML="";
}

/* ===== RECEITA ===== */
function addIng(){
  const t=qtd.value*custo.value;
  receita.push({ing:ing.value,qtd:qtd.value,un:un.value,custo:custo.value,total:t});
  total+=t;
  render();
}
function render(){
  listaIng.innerHTML=receita.map(r=>`<p>${r.ing} - R$ ${r.total.toFixed(2)}</p>`).join("");
  totalSpan.innerText=total.toFixed(2);
  rend.innerText=rendimento.value||0;
  unit.innerText=rendimento.value?(total/rendimento.value).toFixed(2):"0.00";
}

/* ===== SALVAR ===== */
async function salvar(){
  await sb.from("ficha_tecnica").insert({
    produto_id:produtoVF.id,
    produto_nome:produtoVF.descricao,
    unidade_produto:produtoVF.unidadeDeVenda,
    receita,
    rendimento:rendimento.value,
    custo_total:total,
    custo_unitario:total/rendimento.value
  });
  alert("Ficha salva");
  carregar();
}

/* ===== LISTAR ===== */
async function carregar(){
  const {data}=await sb.from("ficha_tecnica")
    .select("*")
    .order("created_at",{ascending:false});
  tabela.innerHTML=`<tr><th>Produto</th><th>Un</th><th>Custo</th></tr>`+
    (data||[]).map(d=>`
      <tr onclick='abrir(${JSON.stringify(d)})'>
        <td>${d.produto_nome}</td>
        <td>${d.unidade_produto}</td>
        <td>R$ ${d.custo_unitario.toFixed(2)}</td>
      </tr>
    `).join("");
}
function abrir(d){
  modal.style.display="flex";
  modalConteudo.textContent=JSON.stringify(d,null,2);
}
carregar();
</script>
</body>
</html>
